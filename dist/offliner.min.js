!function(e){"use strict";function t(e){Object.defineProperty(this,"_uniquename",{get:function(){return e?e+":":""}}),this._isStarted=!1,this._isMiddleware=!1,this._middleware=null,Object.defineProperty(this,"_updateControl",{value:{scheduled:!1,alreadyRunOnce:!1,intervalId:null,inProgressProcess:null}}),Object.defineProperty(this,"fetch",{value:new r}),Object.defineProperty(this,"prefetch",{value:new n}),Object.defineProperty(this,"update",{value:new i})}function n(){this._resourceFetchers={},this._resources=[]}function i(){this._options={}}function r(){this._pipeline=[]}["log","warn","error"].forEach(function(t){e[t]=console[t].bind(console)});var o="-offliner:v0",s="__offliner-config";t.prototype.standalone=function(){if(this._isMiddleware)throw new Error("offliner has been already started as a middleware.");this._isStarted||(e.addEventListener("install",function(t){t.waitUntil(this._install().then(function(){return log("Offliner installed"),"function"==typeof e.skipWaiting?e.skipWaiting():Promise.resolve()}))}.bind(this)),e.addEventListener("activate",function(t){var n=function(){return log("Offliner activated!"),"function"==typeof e.clients.claim?e.clients.claim():Promise.resolve()};t.waitUntil(this._activate().then(n,n))}.bind(this)),e.addEventListener("fetch",function(e){e.respondWith("GET"!==e.request.method?fetch(e.request):this._fetch(e.request))}.bind(this)),e.addEventListener("message",function(e){this._processMessage(e.data)}.bind(this)),this._isStarted=!0)},t.prototype.asMiddleware=function(){if(this._isStarted)throw new Error("offliner has been already installed in standalone mode");return this._middleware||(this._middleware={onInstall:this._install.bind(this),onActivate:this._activate.bind(this),onFetch:function(e,t){return t||"GET"!==e.method?Promise.resolve(t):void this._fetch(e)}.bind(this),onMessage:function(e){this._processMessage(e.data)}.bind(this)}),this._isMiddleware=!0,this._middleware},t.prototype._activate=function(){return this.get("activation-pending").then(function(e){e&&this._sendActivationPending()}.bind(this))},t.prototype._processMessage=function(e){switch(e.type){case"xpromise":this._receiveCrossPromise(e.id,e.order);break;default:warn("Message not recognized:",e)}},t.prototype._receiveCrossPromise=function(e,t){switch(t){case"update":;this._update().then(this._resolve.bind(this,e),this._reject.bind(this,e));break;case"activate":this._activateNextCache().then(this._resolve.bind(this,e),this._reject.bind(this,e));break;default:warn("Cross Promise implementation not recognized:",t)}},t.prototype._resolve=function(e,t){this._resolvePromise(e,"resolved",t)},t.prototype._reject=function(e,t){this._resolvePromise(e,"rejected",t)},t.prototype._resolvePromise=function(e,t,n){this._broadcastMessage({type:"xpromise",id:e,status:t,value:n})},t.prototype.get=function(e){var t=this._getConfigURL(e);return caches.open(s).then(function(e){return e.match(t).then(function(e){return e?e.json():Promise.resolve(null)})})},t.prototype.set=function(e,t){var n=this._getConfigURL(e),i=new Response(JSON.stringify(t));return caches.open(s).then(function(e){return e.put(n,i)})},t.prototype._getConfigURL=function(e){return"http://config/"+this._uniquename+e},t.prototype._install=function(){var e=!0;return this.get("current-version").then(function(t){var n=this.update.option("enabled");return t?n?this._update(e):Promise.resolve():this._initialize().then(this._prefetch.bind(this))}.bind(this),error)},t.prototype._initialize=function(){return this._getCacheNameForVersion(o).then(this.set.bind(this,"active-cache")).then(this.set.bind(this,"current-version",o)).then(this.set.bind(this,"activation-pending",!1))},t.prototype._update=function(e){function t(e){return e?i._getCacheNameForVersion(e).then(caches.open.bind(caches)).then(i._evolveCache.bind(i)).then(i.set.bind(i,"activation-pending",!0)).then(i._sendActivationPending.bind(i)).then(function(){return n(),Promise.resolve(e)}):(n(),Promise.reject("no-update-needed"))}function n(){i._updateControl.alreadyRunOnce=!0,i._updateControl.inProgressProcess=null}var i=this;return this._updateControl.inProgressProcess||(this._updateControl.inProgressProcess=this.get("current-version").then(function(t){this.update.flags={isCalledFromInstall:e,isFirstUpdate:t===o}}.bind(this)).then(this._getLatestVersion.bind(this)).then(this._checkIfNewVersion.bind(this)).then(t)),this._updateControl.inProgressProcess},t.prototype._sendActivationPending=function(){this._broadcastMessage({type:"activationPending"})},t.prototype._sendActivationDone=function(){this._broadcastMessage({type:"activationDone"})},t.prototype._sendActivationFailed=function(){this._broadcastMessage({type:"activationFailed"})},t.prototype._broadcastMessage=function(e){if(e.type="offliner:"+e.type,this._isMiddleware)this.asMiddleware().broadcastMessage(e,"offliner-channel");else if("function"==typeof BroadcastChannel){var t=new BroadcastChannel("offliner-channel");t.postMessage(e),t.close()}else clients.matchAll().then(function(t){t.forEach(function(t){t.postMessage(e)})})},t.prototype._getCacheNameForVersion=function(e){return Promise.resolve(this._uniquename+"cache-"+e)},t.prototype._prefetch=function(){return this._openActiveCache().then(this._doPrefetch.bind(this))},t.prototype._doPrefetch=function(e){function t(e,t){var n=e.reduce(function(e,t){return e[t.type]=[],e},{});return t.forEach(function(e){var t=n[e.type];t&&t.push(e)}),n}var n=this.prefetch.resources(),i=this.prefetch.fetchers(),r=t(i,n);return i.reduce(function(t,n){return t.then(function(){var t=r[n.type];return n.prefetch(t,e)})},Promise.resolve())},t.prototype._getLatestVersion=function(){return this.update.check()},t.prototype._checkIfNewVersion=function(e){return this.get("current-version").then(function(t){var n=this.update.isNewVersion(t,e);return n?(log("New version "+e+" found!"),log(t?"Updating from version "+t:"First update"),this.set("next-version",e).then(function(){return e})):(log("No update needed"),null)}.bind(this))},t.prototype._evolveCache=function(e){return this._openActiveCache().then(function(t){var n=this._doPrefetch.bind(this,e);return this.update.evolve(t,e,n)}.bind(this))},t.prototype._openActiveCache=function(){return this.get("active-cache").then(caches.open.bind(caches))},t.prototype._activateNextCache=function(){return this.get("activation-pending").then(function(e){return e?this._swapCaches().then(this._updateCurrentVersion.bind(this)):Promise.reject("no-activation-pending")}.bind(this))},t.prototype._swapCaches=function(){function e(){return r.get("active-cache")}function t(){return r.get("next-version").then(r._getCacheNameForVersion.bind(r))}function n(e){var t=(e[0],e[1]);return r.set("active-cache",t).then(i([t,s]))}function i(e){return function(){return caches.keys().then(function(t){return Promise.all(t.filter(function(t){return e.indexOf(t)<0}).map(function(e){return caches["delete"](e)}))})}}var r=this;return Promise.all([e(),t()]).then(n)},t.prototype._updateCurrentVersion=function(){var e=this.get("next-version");return e.then(this.set.bind(this,"current-version")).then(this.set.bind(this,"activation-pending",!1)).then(function(){return e})},t.prototype._fetch=function(e){return new Promise(function(t,n){this._openActiveCache().then(function(i){function r(o,s){s=s||0;o.length;s===o.length?n():o[s](e,i).then(t,function(){r(o,s+1)})}var o=this.fetch.pipeline();r(o)}.bind(this))}.bind(this))},n.prototype.use=function(e){return this._resourceFetchers[e.type]=e,this._activeFetcher=e,this},n.prototype.resources=function(e){if(0===arguments.length)return this._resources;Array.isArray(e)||(e=[e]);for(var t,n=0;t=e[n];n++){var i;if("object"!=typeof t||!t||!t.type)try{i=this._activeFetcher.normalize(t)}catch(r){}i?this._resources.push(i):warn(t,"can not be normalized by",this._activeFetcher.type)}return this},n.prototype.fetchers=function(){return Object.keys(this._resourceFetchers).map(function(e){return this._resourceFetchers[e]}.bind(this))},i.prototype.option=function(e,t){return 2===arguments.length?(this._options[e]=t,this):1===arguments.length?this._options[e]:void 0},i.prototype.use=function(e){return this.option("enabled",!0),this._impl=e,this},Object.defineProperty(i.prototype,"flags",{set:function(e){this._impl.flags=e},get:function(){return this._impl.flags}}),i.prototype.check=function(){return this._impl&&this._impl.check()},i.prototype.isNewVersion=function(e,t){return this._impl.isNewVersion(e,t)},i.prototype.evolve=function(e,t,n){return this._impl.evolve(e,t,n)},r.prototype.use=function(e){return this._pipeline.push(e),this},r.prototype.pipeline=function(){return this._pipeline},r.prototype.orFail=function(){this.use(function(){return Promise.reject(new Error("End of fetch pipeline!"))})},e.off={},e.off.Offliner=t,e.off.sources={},e.off.fetchers={},e.off.updaters={}}("undefined"==typeof self?this:self);