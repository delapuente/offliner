<!DOCTYPE html>

<html>
<head>
  <title>offliner-updater-reinstall.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
<div id="container">
  <table cellspacing="0" cellpadding="0">
    <thead>
    <tr>
      <th class="docs">
        
        <h1><a href="../index.html" title="Back to index">&larr;</a>&nbsp;&nbsp;offliner-updater-reinstall.js</h1>
        
      </th>
      <th class="code"></th>
    </tr>
    </thead>
    <tbody>
    
    
    <tr id="section-1">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
      <p><strong>How to write an update implementation</strong></p>
      </td>
      <td class="code">
      <pre><code >
</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-2">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
      <p>Remember including offliner will export the <code>off</code> module with a namespace
 reserved for <code>updaters</code>. Put your update implementation inside.</p>
      </td>
      <td class="code">
      <pre><code ><span class="keyword">self</span><span class="variable">.off</span><span class="variable">.updaters</span><span class="variable">.reinstall</span> = {

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-3">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
      <p>Should check for the latest version. It must return a promise resolving
 with a version tag, which is a string representing the version.</p>
      </td>
      <td class="code">
      <pre><code >  check: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-4">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
      <p>For this demo we are checking the hash of the HEAD of gh-pages branch
 on GitHub. We will use the free GitHub API for that end.</p>
      </td>
      <td class="code">
      <pre><code >    <span class="title">var</span> ghInfo = this.getGHInfoFromGHPages(self.location);
    <span class="title">var</span> path = [
      <span class="string">'repos'</span>, ghInfo.username, ghInfo.repo, <span class="string">'commits'</span>, <span class="string">'gh-pages'</span>
    ].join(<span class="string">'/'</span>);
    <span class="title">var</span> updateChannel = <span class="string">'https:</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-5">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
      <p>api.github.com/' + path;</p>
      </td>
      <td class="code">
      <pre><code >
    </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-6">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
      <p>Once we know the API URL, simply fetch and extract the hash field from
 the response.</p>
      </td>
      <td class="code">
      <pre><code >    <span class="keyword">return</span> fetch(updateChannel).then(<span class="function"><span class="keyword">function</span> <span class="params">(response)</span> {</span>
      <span class="keyword">if</span> (response.status === <span class="number">200</span>) {
        <span class="keyword">return</span> response.json().then(<span class="function"><span class="keyword">function</span> <span class="params">(body)</span> {</span>
          <span class="keyword">return</span> Promise.resolve(<span class="string">'v'</span> + body.sha);
        });
      }
      <span class="keyword">else</span> {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Can not check for new version: '</span> + response.status);
      }
    });
  },

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-7">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
      <p>Should check if the version from the step above is a new version given the
 current one. Notice <strong>offliner</strong> is not aware about the meaning of your
 versions but you could write middleware understanding semver for instance.</p>
      </td>
      <td class="code">
      <pre><code >  isNewVersion: <span class="function"><span class="keyword">function</span> <span class="params">(current, latest)</span> {</span>
    </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-8">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
      <p>The update process set some flags you can check in the <code>flags</code> property.
 Flag <code>isFirstUpdate</code> indicates the worker has triggered the update
 strategy for the first time.</p>
      </td>
      <td class="code">
      <pre><code >    <span class="keyword">return</span> <span class="keyword">this</span><span class="variable">.flags</span><span class="variable">.isFirstUpdate</span> ||
           </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-9">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
      <p>We have a new version every time the hash changes.</p>
      </td>
      <td class="code">
      <pre><code >           current !== latest<span class="comment">;</span>
  },

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-10">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
      <p>Should implement how to update the current cache.</p>
      </td>
      <td class="code">
      <pre><code >  evolve: <span class="function"><span class="keyword">function</span> <span class="params">(previousCache, newCache, reinstall)</span> {</span>
    </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-11">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
      <p>The callback <code>reinstall</code> is provided to trigger a prefetch directly
 on the new cache. Several times, the only thing you need to do in order
 to update is to reinstall all again.</p>
      </td>
      <td class="code">
      <pre><code >    <span class="keyword">return</span> reinstall();
  },

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-12">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
      <p>Of course you can provide as many extra functions as you need.</p>
      </td>
      <td class="code">
      <pre><code >  getGHInfoFromGHPages: function (url) {
    return {
      username: url<span class="preprocessor">.host</span><span class="preprocessor">.split</span>(<span class="string">'.'</span>)[<span class="number">0</span>],
      repo: url<span class="preprocessor">.pathname</span><span class="preprocessor">.split</span>(<span class="string">'/'</span>)[<span class="number">1</span>]
    }<span class="comment">;</span>
  }
}<span class="comment">;</span>
</code></pre>
      </td>
    </tr>
    
  </table>
</div>
</body>
</html>



